#!/bin/bash

# Cleveland LCR Daemon - Control Script
#
# useage: ./cl-lcr-daemon [start|stop|register|unregister]
#
# Created by: Matthew Dunham <matt@hotcoffeydesign.com>

function program_is_installed {
	local return_=1
	type $1 >/dev/null 2>&1 || { local return_=0; }
	echo "$return_"
}

function program_is_running {
	local return_=1
	pidof $1 >/dev/null 2>&1 || { local return_=0; }
	echo "$return_"
}

function npm_package_is_installed {
	local return_=1
	ls node_modules | grep $1 >/dev/null 2>&1 || { local return_=0; }
	echo "$return_"
}

function echo_fail {
	printf "\e[31m✘ ${1}"
	printf "\033\e[0m"
}

function echo_pass {
	printf "\e[32m✔ ${1}"
	printf "\033\e[0m"
}

function echo_if {
	if [ $1 == 1 ]; then
		echo_pass $2
	else
		echo_fail $2
	fi
}

case "$1" in
	start)
		echo "Verifying Dependencies..."
		echo " - node        $(echo_if $(program_is_installed node))"
		echo " - bleno       $(echo_if $(npm_package_is_installed bleno))"
		echo " - serialport  $(echo_if $(npm_package_is_installed serialport))"
		echo "-------------------------"
		echo -n "Starting cl-lcr-daemon - "
		(`which node` /root/cl-lcr-daemon/index.js &>> /root/cl-lcr-daemon/daemon-log.log &)
		sleep 2
		echo "$(echo_if $(program_is_running node))"
    ;;
	stop)
		echo -n "Stopping cl-lcr-daemon... - "
		killall node || (echo "Not Running" && exit 0)
		echo "$(echo_pass)"
	;;
	register)
		echo "Registering the cl-lcr-daemon init.d script..."
		cp `pwd`/cl-lcr-daemon-initd.sh /etc/init.d/cl-lcr-daemon
		chmod 755 /etc/init.d/cl-lcr-daemon
		update-rc.d cl-lcr-daemon defaults
		echo "Registration Complete - $(echo_pass)"
	;;
	unregister)
		echo "Removing the cl-lcr-daemon init.d script..."
		update-rc.d -f cl-lcr-daemon remove
		rm -f /etc/init.d/cl-lcr-daemon
		echo "Unregistration Complete - $(echo_pass)"
	;;
	*)
		echo "Usage: ./cl-lcr-daemon [start|stop|register|unregister]"
		exit 1
    ;;
esac

exit 0